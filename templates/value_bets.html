{% extends 'base.html' %}

{% block title %}Value Bets{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='value_bets.css') }}">
{% endblock %}

{% block content %}
<h1 style="text-align: center;">Value Bets</h1>
<p style="text-align: center;">This page displays value bets based on calculated probabilities and odds.</p>

<!-- Filter Button to Open Popup (Centered) -->
<div class="filter-button-wrapper">
    <button onclick="openFilterPopup()" class="filter-button">Filter Options</button>
</div>


<!-- Popup Box for Filters -->
<div id="filterPopup" class="filter-popup">
    <h3>Select Bookmakers</h3>
    <label><input type="checkbox" name="bookmaker" value="1xBet"> 1xBet</label><br>
    <label><input type="checkbox" name="bookmaker" value="Bet365"> Bet365</label><br>
    <label><input type="checkbox" name="bookmaker" value="WilliamHill"> WilliamHill</label><br>
    <label><input type="checkbox" name="bookmaker" value="Betfair Exchange"> Betfair Exchange</label><br>
    <label><input type="checkbox" name="bookmaker" value="Pinnacle"> Pinnacle</label><br>

    <h3>Select Predictability</h3>
    <label><input type="checkbox" name="predictability" value="High"> High</label><br>
    <label><input type="checkbox" name="predictability" value="Good"> Good</label><br>
    <label><input type="checkbox" name="predictability" value="Medium"> Medium</label><br>
    <label><input type="checkbox" name="predictability" value="Poor"> Poor</label><br>

    <h3>Exclude Options</h3>
    <label><input type="checkbox" id="exclude_cups" name="exclude_cups"> Exclude Cup Games</label><br>
    <label><input type="checkbox" id="exclude_friendlies" name="exclude_friendlies"> Exclude Friendlies</label><br>

    <button type="button" class="collapsible">Home Win (FT Result)</button>
    <div class="content">
      <label><input type="checkbox" id="filter-home-win" checked> Include Home Win FT Result</label>
      <div class="filter-settings">
        <label>Min Probability (%): <input type="number" id="home-win-prob-min" value="0" min="0" max="100"></label>
        <label>Max Probability (%): <input type="number" id="home-win-prob-max" value="100" min="0" max="100"></label>
        <label>Min Latest Odds: <input type="number" id="home-win-odds-min" value="1.00" step="0.01"></label>
        <label>Max Latest Odds: <input type="number" id="home-win-odds-max" value="10.00" step="0.01"></label>
        <label>Min Value %: <input type="number" id="home-win-value-min" value="0" step="1"></label>
        <label>Max Value %: <input type="number" id="home-win-value-max" value="100" step="1"></label>
      </div>
    </div>

    <button type="button" class="collapsible">Draw (FT Result)</button>
    <div class="content">
      <label><input type="checkbox" id="filter-draw" checked> Include Draw FT Result</label>
      <div class="filter-settings">
        <label>Min Probability (%): <input type="number" id="draw-prob-min" value="0" min="0" max="100"></label>
        <label>Max Probability (%): <input type="number" id="draw-prob-max" value="100" min="0" max="100"></label>
        <label>Min Latest Odds: <input type="number" id="draw-odds-min" value="1.00" step="0.01"></label>
        <label>Max Latest Odds: <input type="number" id="draw-odds-max" value="10.00" step="0.01"></label>
        <label>Min Value %: <input type="number" id="draw-value-min" value="0" step="1"></label>
        <label>Max Value %: <input type="number" id="draw-value-max" value="100" step="1"></label>
      </div>
    </div>

    <button type="button" class="collapsible">Away Win (FT Result)</button>
<div class="content">
  <label><input type="checkbox" id="filter-away-win" checked> Include Away Win FT Result</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="away-win-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="away-win-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="away-win-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="away-win-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="away-win-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="away-win-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- HT Result - Home Win -->
<button type="button" class="collapsible">Home Win (HT Result)</button>
<div class="content">
  <label><input type="checkbox" id="filter-home-win-ht" checked> Include Home Win HT Result</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="home-win-ht-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="home-win-ht-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="home-win-ht-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="home-win-ht-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="home-win-ht-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="home-win-ht-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- HT Result - Draw -->
<button type="button" class="collapsible">Draw (HT Result)</button>
<div class="content">
  <label><input type="checkbox" id="filter-draw-ht" checked> Include Draw HT Result</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="draw-ht-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="draw-ht-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="draw-ht-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="draw-ht-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="draw-ht-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="draw-ht-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- HT Result - Away Win -->
<button type="button" class="collapsible">Away Win (HT Result)</button>
<div class="content">
  <label><input type="checkbox" id="filter-away-win-ht" checked> Include Away Win HT Result</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="away-win-ht-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="away-win-ht-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="away-win-ht-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="away-win-ht-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="away-win-ht-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="away-win-ht-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Over 1.5 Goals -->
<button type="button" class="collapsible">Over 1.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-o15" checked> Include Over 1.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="o15-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="o15-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="o15-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="o15-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="o15-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="o15-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Over 2.5 Goals -->
<button type="button" class="collapsible">Over 2.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-o25" checked> Include Over 2.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="o25-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="o25-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="o25-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="o25-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="o25-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="o25-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Over 3.5 Goals -->
<button type="button" class="collapsible">Over 3.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-o35" checked> Include Over 3.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="o35-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="o35-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="o35-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="o35-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="o35-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="o35-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Over 4.5 Goals -->
<button type="button" class="collapsible">Over 4.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-o45" checked> Include Over 4.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="o45-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="o45-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="o45-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="o45-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="o45-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="o45-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Under 1.5 Goals -->
<button type="button" class="collapsible">Under 1.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-u15" checked> Include Under 1.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="u15-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="u15-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="u15-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="u15-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="u15-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="u15-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Under 2.5 Goals -->
<button type="button" class="collapsible">Under 2.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-u25" checked> Include Under 2.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="u25-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="u25-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="u25-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="u25-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="u25-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="u25-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Under 3.5 Goals -->
<button type="button" class="collapsible">Under 3.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-u35" checked> Include Under 3.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="u35-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="u35-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="u35-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="u35-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="u35-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="u35-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Under 4.5 Goals -->
<button type="button" class="collapsible">Under 4.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-u45" checked> Include Under 4.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="u45-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="u45-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="u45-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="u45-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="u45-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="u45-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- BTTS Yes -->
<button type="button" class="collapsible">Both Teams To Score – Yes</button>
<div class="content">
  <label><input type="checkbox" id="filter-btts" checked> Include BTTS Yes</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="btts-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="btts-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="btts-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="btts-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="btts-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="btts-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Home Over 1.5 Goals -->
<button type="button" class="collapsible">Home Over 1.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-home-o15" checked> Include Home Over 1.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="home-o15-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="home-o15-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="home-o15-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="home-o15-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="home-o15-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="home-o15-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Away Over 1.5 Goals -->
<button type="button" class="collapsible">Away Over 1.5 Goals</button>
<div class="content">
  <label><input type="checkbox" id="filter-away-o15" checked> Include Away Over 1.5 Goals</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="away-o15-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="away-o15-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="away-o15-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="away-o15-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="away-o15-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="away-o15-value-max" value="100" step="1"></label>
  </div>
</div>

<!-- Over 8.5 Corners -->
<button type="button" class="collapsible">Over 8.5 Corners</button>
<div class="content">
  <label><input type="checkbox" id="filter-o85" checked> Include Over 8.5 Corners</label>
  <div class="filter-settings">
    <label>Min Probability (%): <input type="number" id="o85-prob-min" value="0" min="0" max="100"></label>
    <label>Max Probability (%): <input type="number" id="o85-prob-max" value="100" min="0" max="100"></label>
    <label>Min Latest Odds: <input type="number" id="o85-odds-min" value="1.00" step="0.01"></label>
    <label>Max Latest Odds: <input type="number" id="o85-odds-max" value="10.00" step="0.01"></label>
    <label>Min Value %: <input type="number" id="o85-value-min" value="0" step="1"></label>
    <label>Max Value %: <input type="number" id="o85-value-max" value="100" step="1"></label>
  </div>
</div>

    <br>
    <button onclick="applyFilter()" class="apply-filter">Apply Filter</button>
    <button onclick="closeFilterPopup()" class="close-filter">Close</button>
</div>

<!-- Table to display the value bets -->
<div class="value-bets-container">
    <table class="value-bets-table">
        <thead>
            <tr>
                <th>Competition</th>
                <th>Predictability</th>
                <th>Fixture Name</th>
                <th>Kickoff Time</th>
                <th>Market Name</th>
                <th onclick="sortTable(5)">Probability (%)</th>
                <th onclick="sortTable(6)">Implied Odds</th>
                <th>Bookmaker</th>
                <th onclick="sortTable(8)">Latest Odds</th>
                <th onclick="sortTable(9)">Value %</th>
                <th>Stake (10% Kelly)</th>
            </tr>
        </thead>
        <tbody>
    {% for bet in value_bets %}
    <tr>
        <td>{{ bet.competition_country }} - {{ bet.competition_name }}</td>
        <td>{{ bet.competition_predictability | default("Unknown") | capitalize }}</td>
        <td>
            <a href="{{ url_for('game_details', fixture_id=bet.fixture_id) }}" target="_blank" style="text-decoration: none; color: #007bff;">
                {{ bet.home_name }} vs {{ bet.away_name }}
            </a>
        </td>
        <td>{{ bet.ko_human }}</td>
        <td>{{ market_name_mapping.get(bet.market, bet.market) }}</td>
        <td>{{ bet.probability }}%</td>
        <td>{{ bet.implied_odds }}</td>
        <td>{{ bet.bookmaker }}</td>
        <td>{{ bet.latest_odds }}</td>
        <td>{{ bet.value_percentage }}</td>
        <td>
          {% set p = bet.probability / 100 %}
          {% set q = 1 - p %}
          {% set b = bet.latest_odds | float - 1 %}
          {% set full_kelly = ((b * p) - q) / b %}
          {% set kelly_fraction = full_kelly if full_kelly > 0 else 0 %}
          {{ "%.2f"|format(kelly_fraction * 100 * 0.1) }}
        </td>
        </tr>        
            {% endfor %}
        </tbody>
        </table>
        </div>


<!-- JavaScript -->
<script>
    const marketNameMapping = {{ market_name_mapping | tojson }};
    let fullValueBetsData = [];
    let filtersInitialized = false;

    async function fetchInitialValueBets() {
        try {
            const response = await fetch('/api/value_bets');
            const data = await response.json();
            fullValueBetsData = data; // ✅ store full data
            renderFilteredTable(data);
        } catch (error) {
            console.error("❌ Failed to load initial value bets:", error);
        }
    }

    function openFilterPopup() {
        const popup = document.getElementById("filterPopup");
        popup.style.display = "block";

        if (!filtersInitialized) {
            const marketCheckboxes = popup.querySelectorAll("input[type='checkbox'][id^='filter-']");
            marketCheckboxes.forEach(cb => cb.checked = false);
            filtersInitialized = true;
        }
    }

    function closeFilterPopup() {
        document.getElementById("filterPopup").style.display = "none";
    }

    function applyFilter() {
        let selectedBookmakers = [];
        document.querySelectorAll("input[name='bookmaker']:checked").forEach(cb => selectedBookmakers.push(cb.value));

        let selectedPredictability = [];
        document.querySelectorAll("input[name='predictability']:checked").forEach(cb => selectedPredictability.push(cb.value));

        let selectedMarkets = [];
        document.querySelectorAll("input[name='market']:checked").forEach(cb => selectedMarkets.push(cb.value));

        const minProb = parseFloat(document.getElementById("minProbability").value) || 0;
        const maxProb = parseFloat(document.getElementById("maxProbability").value) || 100;

        const minValue = parseFloat(document.getElementById("minValue").value) || -100;
        const maxValue = parseFloat(document.getElementById("maxValue").value) || 100;

        let excludeCups = document.getElementById("exclude_cups").checked;
        let excludeFriendlies = document.getElementById("exclude_friendlies").checked;

        if (fullValueBetsData.length === 0) {
            console.warn("⏳ Value bets data not loaded yet. Retrying shortly...");
            setTimeout(applyFilter, 300);
            return;
        }

        let filtered = fullValueBetsData.filter(item => {
            if (excludeCups && item.competition?.toLowerCase().includes("cup")) return false;
            if (excludeFriendlies && item.competition?.toLowerCase().includes("friendly")) return false;

            if (selectedBookmakers.length > 0 && !item.odds?.some(o => selectedBookmakers.includes(o.bookmaker_name))) return false;
            if (selectedPredictability.length > 0 && !selectedPredictability.includes(item.predictability)) return false;
            if (selectedMarkets.length > 0 && !selectedMarkets.includes(item.market)) return false;

            if (typeof item.probability === "number" && (item.probability < minProb || item.probability > maxProb)) return false;
            if (typeof item.value === "number" && (item.value < minValue || item.value > maxValue)) return false;

            return true;
        });

        renderFilteredTable(filtered);
    }

    function renderFilteredTable(data) {
        const tableBody = document.querySelector("#valueBetsTable tbody");
        tableBody.innerHTML = "";

        data.forEach(item => {
            const row = document.createElement("tr");

            const marketCell = document.createElement("td");
            marketCell.textContent = marketNameMapping[item.market] || item.market;
            row.appendChild(marketCell);

            const fixtureCell = document.createElement("td");
            fixtureCell.textContent = item.fixture_name || '';
            row.appendChild(fixtureCell);

            const competitionCell = document.createElement("td");
            competitionCell.textContent = item.competition || '';
            row.appendChild(competitionCell);

            const predictabilityCell = document.createElement("td");
            predictabilityCell.textContent = item.predictability || '';
            row.appendChild(predictabilityCell);

            const kickoffCell = document.createElement("td");
            kickoffCell.textContent = item.kickoff_time || '';
            row.appendChild(kickoffCell);

            const probabilityCell = document.createElement("td");
            probabilityCell.textContent = item.probability ? `${item.probability.toFixed(2)}%` : 'N/A';
            row.appendChild(probabilityCell);

            const impliedOddsCell = document.createElement("td");
            impliedOddsCell.textContent = item.implied_odds || 'N/A';
            row.appendChild(impliedOddsCell);

            const bookmakerCell = document.createElement("td");
            bookmakerCell.textContent = item.odds?.[0]?.bookmaker_name || 'N/A';
            row.appendChild(bookmakerCell);

            const latestOddsCell = document.createElement("td");
            latestOddsCell.textContent = item.odds?.[0]?.latest || 'N/A';
            row.appendChild(latestOddsCell);

            const valueCell = document.createElement("td");
            valueCell.textContent = item.value ? `${item.value.toFixed(2)}%` : 'N/A';
            row.appendChild(valueCell);

            tableBody.appendChild(row);
        });
    }

    // 🔄 Fetch and display value bets when the page loads
    fetchInitialValueBets();
</script>

{% endblock %}
